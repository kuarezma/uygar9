<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Uygar Mama Takip</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  html, body {
    margin:0; padding:0;
    font-family:'Quicksand',sans-serif;
    background: linear-gradient(to bottom, #ffffff, #e0f7fa);
    color:#333; text-align:center;
  }
  .header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 15px 0 5px 0;
    position: relative;
    padding-left: 85px; /* ƒ∞konun kapladƒ±ƒüƒ± alanƒ± dengelemek i√ßin ve ba≈ülƒ±ƒüƒ± saƒüa kaydƒ±rmak i√ßin g√ºncellendi */
    box-sizing: border-box;
  }
  #header-icon {
    height: 72px;
    border-radius: 50%;
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
  }
  #title-container {
    text-align: center;
  }
  h1 { font-size:28px; color:#e53935; margin: 0; }
  #clock { font-size:26px; font-weight:900; margin: 0 auto 5px; }
  #uygarAge { font-weight:bold; margin-bottom:10px; color:#00796b; }
  /* B√ºy√ºk butonlar */
  #startBtn, #stopBtn {
    padding:12px 18px; margin:6px;
    font-size:16px; border:none; border-radius:8px;
    cursor:pointer; font-weight:bold;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s, background 0.3s;
  }
  #startBtn { background:#ff9800; color:#fff; }
  #stopBtn { background:#e53935; color:#fff; }
  /* Diƒüer butonlar k√º√ß√ºk */
  #goalSave, #toggleHistory, #notificationBtn, .edit-btn, .delete-btn, .add-btn {
    padding:6px 8px; margin:2px;
    font-size:12px; border:none; border-radius:6px;
    cursor:pointer; font-weight:bold;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s, background 0.3s;
  }
  button:disabled { opacity:0.5; cursor:default; }
  button:hover:enabled { transform: scale(1.05); }
  #goalSave { background:#8e24aa; color:#fff; }
  #toggleHistory { background:#4caf50; color:#fff; }
  #notificationBtn { background:#03a9f4; color:#fff; }
  .log {
    max-height:300px; overflow-y:auto;
    background: rgba(0,0,0,0.05);
    margin:10px; padding:10px; border-radius:10px;
  }
  .log-entry {
    display:flex; justify-content:space-between; align-items:center;
    margin:4px 0; background: rgba(255,255,255,0.9);
    border-radius:6px; padding:4px 6px; color:#222;
    flex-wrap:nowrap; gap:4px;
  }
  .log-text {
    flex:1; text-align:left; font-weight:bold;
    font-size:13px; white-space:nowrap;
    overflow:hidden; text-overflow:ellipsis;
  }
  .log-buttons {
    display:flex; gap:3px; flex-shrink:0;
  }
  .delete-btn { background:#ff4081; color:#fff; }
  .edit-btn { background:#2196f3; color:#fff; }
  .add-btn { background:#4caf50; color:#fff; }
  .status { margin:10px; font-weight:bold; background: rgba(0,0,0,0.05); padding:8px; border-radius:6px; }
  .goal-input { margin:10px; }
  .goal-input input {
    padding:6px; font-size:16px; width:80px; text-align:center;
    border:1px solid #ccc; border-radius:6px;
  }
  #waitTimer { color:#d32f2f; }
  #hourglassIcon { font-size: 20px; margin-left: 6px; vertical-align: middle; }

  /* Modal (A√ßƒ±lƒ±r Pencere) Stilleri */
  .modal-hidden { display: none !important; }
  #modal-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    justify-content: center; align-items: center;
    display: flex; z-index: 1000;
    padding: 15px;
    box-sizing: border-box;
  }
  #modal-content {
    background: #fff; padding: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 100%; max-width: 320px;
    text-align: center;
  }
  #modal-title { margin-top: 0; color: #e53935; font-size: 22px; }
  #modal-text { margin-top: 0; margin-bottom: 15px; font-size: 16px; }
  #modal-input-container input {
    width: 100%;
    padding: 10px; margin-bottom: 15px;
    border: 1px solid #ccc; border-radius: 8px;
    font-size: 16px; text-align: center;
    box-sizing: border-box;
  }
  #modal-buttons button {
    padding: 10px 20px; font-size: 16px;
    border: none; border-radius: 8px;
    cursor: pointer; margin: 0 5px;
    font-weight: bold;
  }
  #modal-buttons .confirm-btn { background: #4caf50; color: white; }
  #modal-buttons .cancel-btn { background: #f44336; color: white; }

  /* Grafik Stilleri */
  .chart-container {
      margin-top: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.05);
      border-radius: 10px;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<div class="header">
  <img src="https://i.imgur.com/wKpbz6H.jpg" id="header-icon">
  <div id="title-container">
    <h1>Uygar Mama Takip</h1>
  </div>
</div>
<div id="clock"></div>
<div id="uygarAge"></div>
<button id="startBtn">üçº Mama Ba≈üladƒ±</button>
<button id="stopBtn" disabled>‚úÖ Mama Bitti</button>
<button id="toggleHistory">üìÇ Ge√ßmi≈ü Kayƒ±tlarƒ± G√∂ster</button>
<button id="notificationBtn">üîî Bildirimleri A√ß</button>

<div class="goal-input">
  G√ºnl√ºk hedef:
  <input type="number" id="goalInput" value="900"> ml
  <button id="goalSave">Kaydet</button>
</div>

<div id="waitTimer">Bekleme S√ºresi: <strong>0 saat 0 dakika 0 saniye</strong></div>
<div class="status" id="goalStatus"></div>
<div class="log" id="log"></div>

<!-- Grafik Alanƒ± -->
<div class="chart-container">
    <canvas id="dailyChart"></canvas>
</div>


<!-- Modal HTML Yapƒ±sƒ± -->
<div id="modal-overlay" class="modal-hidden">
  <div id="modal-content">
    <h2 id="modal-title"></h2>
    <p id="modal-text"></p>
    <div id="modal-input-container"></div>
    <div id="modal-buttons"></div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  databaseURL: "https://uygar-mama-takibi-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let waitInterval = null;
let dailyGoal = 900; 
let showHistory = false;
let allRecords = [];
let dailyChartInstance; 
let notificationTimeoutId = null;

// Modal elementleri ve fonksiyonu
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalText = document.getElementById('modal-text');
const modalInputContainer = document.getElementById('modal-input-container');
const modalButtons = document.getElementById('modal-buttons');
const notificationBtn = document.getElementById('notificationBtn');

// Bildirim Fonksiyonlarƒ±
function updateNotificationButton() {
    if (!('Notification' in window)) {
        notificationBtn.textContent = 'üîï Desteklenmiyor';
        notificationBtn.disabled = true;
        return;
    }
    switch(Notification.permission) {
        case 'granted':
            notificationBtn.textContent = 'üîî Bildirimler A√ßƒ±k';
            notificationBtn.style.background = '#4caf50';
            break;
        case 'denied':
            notificationBtn.textContent = 'üîï Bildirim Engelli';
            notificationBtn.disabled = true;
            break;
        default:
            notificationBtn.textContent = 'üîî Bildirimleri A√ß';
            notificationBtn.style.background = '#03a9f4';
    }
}

function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    Notification.requestPermission().then(permission => {
        updateNotificationButton();
        if (permission === 'granted') {
            // ƒ∞zin verildiƒüinde, mevcut son kayda g√∂re bildirimi hemen zamanla
            if (allRecords.length > 0) {
                scheduleNotification(allRecords[0].timestamp, allRecords[0].ml);
            }
        }
    });
}

// G√úNCELLENDƒ∞: Bildirim Zamanlama Mantƒ±ƒüƒ±
function scheduleNotification(lastFeedTimestamp, lastFeedAmount) {
    if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
    
    if (Notification.permission !== 'granted' || !lastFeedTimestamp || !lastFeedAmount || lastFeedAmount <= 0) {
        return;
    }

    // YENƒ∞ MANTIK: Her 40 ml i√ßin 1 saat bekleme s√ºresi hesapla
    const hoursToWait = lastFeedAmount / 40;
    const NOTIFICATION_DELAY = hoursToWait * 60 * 60 * 1000;

    const notificationTime = lastFeedTimestamp + NOTIFICATION_DELAY;
    const delay = notificationTime - Date.now();

    if (delay > 0) {
        notificationTimeoutId = setTimeout(() => {
            new Notification('Uygar Mama Zamanƒ±!', {
                body: `Son mama (${lastFeedAmount} ml) √ºzerinden yakla≈üƒ±k ${hoursToWait.toFixed(1).replace('.', ',')} saat ge√ßti.`,
                icon: 'https://i.imgur.com/wKpbz6H.jpg'
            });
        }, delay);
    }
}

document.addEventListener('DOMContentLoaded', updateNotificationButton);
notificationBtn.addEventListener('click', requestNotificationPermission);


function showModal({ title, text, inputs = [], buttons = [] }) {
    return new Promise((resolve) => {
        modalTitle.textContent = title || '';
        modalText.textContent = text || '';
        modalText.style.display = text ? 'block' : 'none';
        
        modalInputContainer.innerHTML = '';
        inputs.forEach(inputConfig => {
            const input = document.createElement('input');
            input.type = inputConfig.type || 'text';
            input.id = inputConfig.id;
            input.placeholder = inputConfig.placeholder || '';
            input.value = inputConfig.value || '';
            if (inputConfig.type === 'number') {
                input.pattern = '\\d*';
            }
            modalInputContainer.appendChild(input);
        });

        modalButtons.innerHTML = '';
        buttons.forEach(buttonConfig => {
            const button = document.createElement('button');
            button.textContent = buttonConfig.text;
            button.className = buttonConfig.class;
            button.onclick = () => {
                const result = {};
                if (inputs.length > 0) {
                    inputs.forEach(inputConfig => {
                        result[inputConfig.id] = document.getElementById(inputConfig.id).value;
                    });
                }
                modalOverlay.classList.add('modal-hidden');
                resolve({ button: buttonConfig.text, ...result });
            };
            modalButtons.appendChild(button);
        });

        modalOverlay.classList.remove('modal-hidden');
        if (inputs.length > 0) {
            document.getElementById(inputs[0].id).focus();
        }
    });
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = "üïí " + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

function updateUygarAge() {
  const birth = new Date(2025, 4, 10, 13, 59);
  const now = new Date();
  const diffTime = now - birth;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  const diffWeeks = Math.floor(diffDays / 7);
  const remainingDaysInWeek = diffDays % 7;
  const months = Math.floor(diffDays / 30);
  
  const el = document.getElementById("uygarAge");
  el.textContent = `Uygar ${months} aylƒ±k (${diffWeeks} hafta, ${remainingDaysInWeek} g√ºn)`;
}
updateUygarAge();

function formatDuration(ms) {
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${h} saat ${m} dakika ${sec} saniye`;
}

db.ref("status").on("value", snap=>{
  const state = snap.val() || "idle";
  document.getElementById('startBtn').disabled = state==="feeding";
  document.getElementById('stopBtn').disabled = state!=="feeding";
});

db.ref("waitStatus").on("value", snap=>{
  const ts = snap.val();
  const timerEl = document.getElementById('waitTimer');

  if(ts){
    if(waitInterval) clearInterval(waitInterval);
    waitInterval = setInterval(()=>{
      const nowElapsed = Date.now() - ts;
      const durationText = formatDuration(nowElapsed);
      timerEl.innerHTML = `Bekleme S√ºresi: <strong>${durationText}</strong> <span id="hourglassIcon">‚è≥</span>`;
    },1000);
  } else {
    if(waitInterval) clearInterval(waitInterval);
    timerEl.innerHTML = `Bekleme S√ºresi: <strong>0 saat 0 dakika 0 saniye</strong> <span id="hourglassIcon">‚è≥</span>`;
  }
});

db.ref("dailyGoal").on("value", snap => {
    const goalFromDb = snap.val();
    if (goalFromDb !== null && !isNaN(goalFromDb)) {
        dailyGoal = parseInt(goalFromDb);
        document.getElementById('goalInput').value = dailyGoal;
    }
    renderLog();
});

document.getElementById('toggleHistory').addEventListener('click', ()=>{
  showHistory = !showHistory;
  document.getElementById('toggleHistory').textContent = showHistory ? "üìÇ Ge√ßmi≈ü Kayƒ±tlarƒ± Gizle" : "üìÇ Ge√ßmi≈ü Kayƒ±tlarƒ± G√∂ster";
  renderLog();
});

db.ref("feedings").on("value", snapshot=>{
  allRecords = [];
  snapshot.forEach(child=>{
    allRecords.push({...child.val(), key:child.key});
  });
  
  allRecords.forEach(r => {
      if(r.date && r.time && r.date.includes('.') && r.time.includes(':')) {
        const dateParts = r.date.split('.');
        const timeParts = r.time.split(':');
        r.timestamp = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1]).getTime();
      } else {
        r.timestamp = 0;
      }
  });
  allRecords.sort((a, b) => b.timestamp - a.timestamp); 
  
  // G√úNCELLENDƒ∞: Bildirim zamanlamasƒ± artƒ±k buradan y√∂netiliyor.
  if (allRecords.length > 0) {
      scheduleNotification(allRecords[0].timestamp, allRecords[0].ml);
  } else {
      scheduleNotification(null, 0); // Kayƒ±t yoksa bekleyen bildirimi iptal et
  }
  
  renderLog();
  updateChart(); 
});

function renderLog() {
  const log = document.getElementById('log');
  log.innerHTML = "";
  let todayTotal=0;
  const todayStr = new Date().toLocaleDateString("tr-TR");
  const filtered = allRecords.filter(r => showHistory || r.date === todayStr);
  
  filtered.forEach(r=>{
    if(r.date===todayStr) todayTotal+=r.ml||0;
    const entry = document.createElement("div");
    entry.className = "log-entry";

    const text = document.createElement("div");
    text.className = "log-text";
    const dateText = showHistory && r.date !== todayStr ? `[${r.date}] ` : "";

    text.innerHTML = `${dateText}<span style="color:red; font-weight:900; font-size: 15px;">${r.time || ""}</span> - üçº <span style="font-weight:900; font-size: 15px;">${r.ml || ""} ml</span>`;

    const buttons = document.createElement("div");
    buttons.className = "log-buttons";

    const edit = document.createElement("button");
    edit.className = "edit-btn";
    edit.textContent = "D√ºzelt";
    edit.onclick = async () => {
      const result = await showModal({
          title: 'Miktarƒ± D√ºzelt',
          inputs: [{ id: 'mlEditInput', type: 'number', value: r.ml || '0' }],
          buttons: [
              { text: 'G√ºncelle', class: 'confirm-btn' },
              { text: 'ƒ∞ptal', class: 'cancel-btn' }
          ]
      });
      if (result.button === 'G√ºncelle') {
        let yeniMl=parseInt(result.mlEditInput) || 0;
        db.ref("feedings/"+r.key).update({ml: yeniMl});
      }
    };

    const add = document.createElement("button");
    add.className = "add-btn";
    add.textContent = "Ekle";
    add.onclick = async () => {
      const now = new Date();
      const defaultTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const defaultDate = now.toLocaleDateString("tr-TR");

      const result = await showModal({
          title: 'Manuel Kayƒ±t Ekle',
          inputs: [
              { id: 'dateInput', type: 'text', value: defaultDate, placeholder: 'Tarih (GG.AA.YYYY)' },
              { id: 'timeInput', type: 'text', value: defaultTime, placeholder: 'Saat (√∂rn: 15:30)' },
              { id: 'mlAddInput', type: 'number', value: '', placeholder: 'Miktar (ml)' }
          ],
          buttons: [
              { text: 'Ekle', class: 'confirm-btn' },
              { text: 'ƒ∞ptal', class: 'cancel-btn' }
          ]
      });
      
      if (result.button === 'Ekle' && result.dateInput && result.timeInput && result.timeInput.includes(':')) {
          let miktar = parseInt(result.mlAddInput) || 0;
          const entryDate = result.dateInput;
          
          if (!/^\d{2}\.\d{2}\.\d{4}$/.test(entryDate)) {
             console.error("Ge√ßersiz tarih formatƒ±.");
             return;
          }

          const dateParts = entryDate.split('.');
          const timeParts = result.timeInput.split(':');
          const manualEntryTimestamp = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1]).getTime();

          const lastRecordTimestamp = allRecords.length > 0 ? allRecords[0].timestamp : 0;
          
          db.ref("feedings").push({
              date: entryDate, 
              time: result.timeInput, 
              ml: miktar
          });

          if (manualEntryTimestamp > lastRecordTimestamp) {
              db.ref("waitStatus").set(manualEntryTimestamp);
          }
      }
    };

    const del = document.createElement("button");
    del.className = "delete-btn";
    del.textContent = "Sil";
    del.onclick = async () => {
      const result = await showModal({
          title: 'Kaydƒ± Sil',
          text: 'Bu kaydƒ± silmek istediƒüinize emin misiniz?',
          buttons: [
              { text: 'Evet, Sil', class: 'cancel-btn' },
              { text: 'Hayƒ±r', class: 'confirm-btn' }
          ]
      });
      if (result.button === 'Evet, Sil') {
          const isDeletingLastRecord = allRecords.length > 0 && allRecords[0].key === r.key;
          
          db.ref("feedings/" + r.key).remove().then(() => {
              if (isDeletingLastRecord) {
                  const newLastRecord = allRecords.length > 1 ? allRecords[1] : null;
                  if (newLastRecord) {
                      db.ref("waitStatus").set(newLastRecord.timestamp);
                  } else {
                      db.ref("waitStatus").remove();
                  }
              }
          });
      }
    };

    buttons.appendChild(edit);
    buttons.appendChild(add);
    buttons.appendChild(del);

    entry.appendChild(text);
    entry.appendChild(buttons);
    log.appendChild(entry);
  });

  const kalan = dailyGoal - todayTotal;
  const yuzdeTamam = dailyGoal > 0 ? Math.min(100, ((todayTotal / dailyGoal) * 100).toFixed(1)) : 0;
  document.getElementById('goalStatus').innerHTML = `ƒ∞√ßilen: ${todayTotal} ml <span style="color:blue"> | </span> Kalan: <span style="color:red">${kalan>0?kalan:0} ml</span> <span style="color:blue"> | </span> <strong>%${yuzdeTamam}</strong>`;
}

function updateChart() {
    const dailyTotals = {};
    const labels = [];

    for (let i = 4; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toLocaleDateString("tr-TR");
        labels.push(dateStr.substring(0, 5)); 
        dailyTotals[dateStr] = 0; 
    }
    
    const relevantRecords = allRecords.filter(r => r.date && dailyTotals[r.date] !== undefined);
    relevantRecords.forEach(r => {
        dailyTotals[r.date] += r.ml || 0;
    });

    const data = Object.values(dailyTotals); 
    
    const ctx = document.getElementById('dailyChart').getContext('2d');

    if (dailyChartInstance) {
        dailyChartInstance.destroy(); 
    }

    dailyChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Son 5 G√ºnl√ºk T√ºketim (ml)',
                data: data,
                backgroundColor: 'rgba(33, 150, 243, 0.2)',
                borderColor: 'rgba(33, 150, 243, 1)',
                borderWidth: 2,
                tension: 0.1,
                fill: true,
                pointBackgroundColor: 'rgba(229, 57, 53, 1)',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

document.getElementById('startBtn').addEventListener('click',()=>{
  if(waitInterval) clearInterval(waitInterval);
  const timerEl = document.getElementById('waitTimer');
  timerEl.innerHTML = `Bekleme S√ºresi: <strong>0 saat 0 dakika 0 saniye</strong> <span id="hourglassIcon">‚è≥</span>`;
  db.ref("waitStatus").remove();
  db.ref("status").set("feeding");
});

// G√úNCELLENDƒ∞: "Mama Bitti" butonu zaman damgasƒ± tutarlƒ±lƒ±ƒüƒ± i√ßin g√ºncellendi
document.getElementById('stopBtn').addEventListener('click', async ()=>{
  const result = await showModal({
    title: 'Mama Miktarƒ±',
    text: 'Uygar ka√ß ml i√ßti?',
    inputs: [{ id: 'mlInput', type: 'number', value: '120', placeholder: 'ml' }],
    buttons: [
        { text: 'Kaydet', class: 'confirm-btn' },
        { text: 'ƒ∞ptal', class: 'cancel-btn' }
    ]
  });
  
  if (result.button === 'ƒ∞ptal') {
      return; 
  }
  
  const now = new Date();
  const dateStr = now.toLocaleDateString("tr-TR");
  const timeStr = now.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
  let miktar = parseInt(result.mlInput) || 0;

  const dateParts = dateStr.split('.');
  const timeParts = timeStr.split(':');
  const timestamp = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1]).getTime();

  db.ref("waitStatus").set(timestamp); 
  
  db.ref("feedings").push({
    date: dateStr,
    time: timeStr,
    ml: miktar
  });
  
  db.ref("status").set("waiting");
});

document.getElementById('goalSave').addEventListener('click',()=>{
  const yeni = document.getElementById('goalInput').value;
  if(yeni && !isNaN(yeni)){
    const newGoal = parseInt(yeni);
    db.ref("dailyGoal").set(newGoal);
    
    const btn = document.getElementById('goalSave');
    btn.textContent = 'Kaydedildi!';
    setTimeout(() => { btn.textContent = 'Kaydet'; }, 1500);
  }
});
</script>
</body>
</html>

